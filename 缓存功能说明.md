# 学习方案缓存功能说明

## 📋 功能概述

现在应用支持本地缓存多个学习方案，用户可以：
1. **查看所有已生成的方案** - 避免重复生成
2. **选择使用已有方案** - 快速开始学习
3. **智能匹配推荐** - 自动找到完全匹配的方案
4. **管理多个方案** - 删除不需要的方案

---

## 🎯 主要优势

### ⚡ 加快速度
- 不需要每次都调用AI生成（节省2-3分钟等待时间）
- 直接使用已有方案，秒开学习路径

### 💾 智能缓存
- 所有生成的方案自动保存到本地
- 支持同时保存多个不同需求的方案
- 自动识别匹配的方案并推荐

### 🔍 方便管理
- 查看所有历史方案
- 一键切换不同方案
- 删除不需要的方案

---

## 🚀 使用流程

### 新用户流程
```
1. 首页 → 开始定制学习计划
2. 填写问卷（目标、水平、时间、学习方式）
3. 进入【方案选择页】
   - 没有已有方案 → 点击"生成新方案"
   - 调用AI生成（等待2-3分钟）
4. 查看学习路径
```

### 老用户流程（有缓存）
```
1. 首页 → 开始定制学习计划
2. 填写问卷
3. 进入【方案选择页】
   ✅ 找到完全匹配的方案
   - 推荐卡片：显示匹配方案的详细信息
   - 点击"使用这个方案" → 立即开始学习（无需等待！）
   - 或点击"生成新方案" → 调用AI重新生成
```

### 查看所有方案
```
1. 首页 → "查看所有方案"按钮（显示方案数量）
2. 方案选择页：
   - 查看所有历史方案
   - 点击任意方案 → 立即使用
   - 点击删除图标 → 删除方案
   - 点击"生成新方案" → 创建新的
```

---

## 💡 智能匹配规则

系统会根据以下条件自动匹配方案：

| 匹配条件 | 说明 |
|---------|------|
| 学习目标 | goal（如：准备高考、考研、兴趣） |
| 当前水平 | currentLevel（如：零基础、高中、大学） |
| 每日时间 | availableTime（如：<1h、1-2h、2h+） |
| 学习方式 | learningStyle（如：视频、书籍、互动工具） |

**完全匹配**：4个条件都相同时，系统会推荐使用已有方案

---

## 🗂️ 数据存储说明

### 存储位置
- **浏览器 localStorage**
- 数据保存在本地，不会上传到服务器

### 存储内容
```javascript
localStorage.setItem('learning_paths', JSON.stringify([
  {
    id: 'path-1699999999999',
    userId: 'user-1',
    subject: 'physics',
    createdAt: '2025-11-06T...',
    updatedAt: '2025-11-06T...',
    userProfile: {
      goal: 'gaokao',
      currentLevel: 'high-school',
      availableTime: '1-2h',
      learningStyle: ['video', 'interactive']
    },
    stages: [...],
    progress: {...}
  },
  // 更多方案...
]))
```

### 清除缓存
- 手动：浏览器设置 → 清除浏览器数据 → 选择"本地存储"
- 代码：`localStorage.clear()` （开发调试用）

---

## 📱 页面说明

### 1. 首页 (`/`)
**老用户（有方案）**
- 显示当前方案的学习进度
- 按钮：
  - 🔵 继续学习
  - 🟢 查看所有方案 (N) ← 新增
  - ⚪ 创建新的学习方案

**新用户（无方案）**
- 显示欢迎页面
- 按钮：
  - 🔵 开始定制我的学习计划
  - 🟢 查看已有方案 (N) ← 新增（如果有缓存）

### 2. 问卷页 (`/questionnaire`)
- 填写学习需求
- 提交后跳转到 **方案选择页**（而不是直接生成）

### 3. 方案选择页 (`/select-path`) ← 新页面
**智能推荐区**（如果有匹配）
- ⭐ 推荐卡片
- 显示匹配方案的详细信息
- 按钮：
  - ✓ 使用这个方案（绿色）
  - 生成新方案（灰色）

**所有方案列表**
- 显示所有已缓存的方案
- 每个方案显示：
  - 📚 图标
  - 学习目标 - 当前水平
  - 创建时间
  - 每日时间、学习方式标签
  - 阶段数、主题数、完成进度
  - 🗑️ 删除按钮
- 点击方案卡片 → 使用该方案
- 点击删除按钮 → 删除方案

**底部按钮**
- 🤖 生成新的学习方案

### 4. 生成页 (`/generate`)
- AI生成学习路径（2-3分钟）
- 显示动画进度条
- 生成完成后自动保存到缓存
- 跳转到学习路径页

### 5. 学习路径页 (`/path`)
- 显示当前使用的学习方案
- 无变化

---

## 🔧 技术实现

### 修改的文件

1. **`lib/storage.ts`** - 存储模块
   - ✅ 新增 `getAllLearningPaths()` - 获取所有方案
   - ✅ 新增 `getLearningPathById()` - 根据ID获取方案
   - ✅ 新增 `deleteLearningPath()` - 删除指定方案
   - ✅ 新增 `setCurrentLearningPath()` - 设置当前方案
   - ✅ 新增 `findMatchingPath()` - 智能匹配方案
   - ✅ 修改 `saveLearningPath()` - 同时保存到方案列表

2. **`app/select-path/page.tsx`** - 方案选择页（新建）
   - ✅ 显示匹配推荐
   - ✅ 显示所有方案列表
   - ✅ 支持删除方案
   - ✅ 支持选择方案
   - ✅ 支持生成新方案

3. **`app/questionnaire/page.tsx`** - 问卷页
   - ✅ 修改提交跳转：`router.push('/select-path')`
   - ✅ 修改提示：OpenAI → DeepSeek

4. **`app/page.tsx`** - 首页
   - ✅ 新增"查看所有方案"按钮
   - ✅ 显示方案数量
   - ✅ 修改"重新规划"为"创建新方案"

### 核心逻辑

**智能匹配算法**
```typescript
export function findMatchingPath(questionnaireData: QuestionnaireData): LearningPath | null {
  const paths = getAllLearningPaths();

  return paths.find(path => {
    const profile = path.userProfile;
    return (
      profile.goal === questionnaireData.goal &&
      profile.currentLevel === questionnaireData.currentLevel &&
      profile.availableTime === questionnaireData.availableTime &&
      JSON.stringify(profile.learningStyle?.sort()) ===
      JSON.stringify(questionnaireData.learningStyle?.sort())
    );
  }) || null;
}
```

**自动保存机制**
```typescript
export function saveLearningPath(path: LearningPath): void {
  // 1. 保存为当前路径
  localStorage.setItem(STORAGE_KEYS.LEARNING_PATH, JSON.stringify(path));

  // 2. 添加到路径列表
  const paths = getAllLearningPaths();
  const existingIndex = paths.findIndex(p => p.id === path.id);

  if (existingIndex >= 0) {
    paths[existingIndex] = path; // 更新
  } else {
    paths.unshift(path); // 新增（放最前面）
  }

  localStorage.setItem(STORAGE_KEYS.LEARNING_PATHS, JSON.stringify(paths));
}
```

---

## 📊 测试场景

### 场景1：首次使用
1. 打开应用 → 首页（无缓存）
2. 点击"开始定制学习计划"
3. 填写问卷：高考、高中、1-2h、视频+互动
4. 进入方案选择页（显示"暂无已保存的学习方案"）
5. 点击"生成新方案" → 等待AI生成
6. 生成完成 → 自动保存到缓存 → 跳转到学习路径页
✅ **结果**：缓存中有1个方案

### 场景2：再次使用（相同需求）
1. 打开应用 → 首页（显示"查看所有方案 (1)"）
2. 点击"创建新的学习方案"
3. 填写问卷：高考、高中、1-2h、视频+互动（与之前相同）
4. 进入方案选择页
   - ⭐ **显示推荐卡片**："我们找到了一个完全匹配您当前需求的学习方案"
5. 点击"✓ 使用这个方案" → 立即跳转到学习路径页（无需等待！）
✅ **结果**：节省了2-3分钟生成时间

### 场景3：不同需求
1. 打开应用 → 首页
2. 点击"创建新的学习方案"
3. 填写问卷：考研、大学、2h+、书籍+练习（不同需求）
4. 进入方案选择页
   - 显示"其他已有方案 (1)"
   - 无推荐卡片（因为不匹配）
5. 点击"生成新方案" → 生成第2个方案
✅ **结果**：缓存中有2个方案

### 场景4：查看和管理方案
1. 打开应用 → 首页（显示"查看所有方案 (2)"）
2. 点击"查看所有方案"
3. 进入方案选择页 → 看到2个方案
4. 点击第1个方案 → 立即使用
5. 返回，点击第2个方案的删除按钮 → 删除确认 → 删除成功
✅ **结果**：缓存中剩1个方案

---

## ⚠️ 注意事项

1. **数据安全**
   - 所有数据保存在本地浏览器
   - 清除浏览器数据会丢失所有方案
   - 建议用户定期导出重要数据（后续可实现）

2. **匹配精度**
   - 必须4个条件完全相同才会推荐
   - 如果学习方式选择顺序不同，依然会匹配（因为进行了排序比较）

3. **存储限制**
   - localStorage通常限制5-10MB
   - 一个学习方案约5-10KB
   - 理论上可以存储500-1000个方案
   - 实际使用中不会超过10-20个

4. **API Key**
   - API Key也保存在本地
   - 不会泄露到服务器
   - 建议不要在公共电脑上使用

---

## 🎉 功能完成情况

✅ 所有功能已实现：
1. ✅ 修改存储模块，支持多方案管理
2. ✅ 创建方案选择页面
3. ✅ 修改路由流程（问卷 → 方案选择 → 生成/使用）
4. ✅ 首页添加"查看所有方案"入口
5. ✅ 智能匹配推荐功能
6. ✅ 方案删除功能
7. ✅ 方案切换功能

---

## 🚀 下一步优化建议

1. **数据导出/导入**
   - 支持导出学习方案为JSON文件
   - 支持导入之前导出的方案

2. **云同步**（需要后端）
   - 用户账号系统
   - 方案云端备份
   - 多设备同步

3. **方案比较**
   - 并排对比两个方案
   - 高亮显示差异

4. **标签和分类**
   - 给方案添加自定义标签
   - 按标签筛选方案

5. **统计分析**
   - 显示学习时长统计
   - 完成进度趋势图

---

## 📝 测试检查清单

测试前请确认服务器正在运行：`npm run dev`

- [ ] 首次使用流程（无缓存）
- [ ] 生成方案后，缓存保存成功
- [ ] 相同需求，显示匹配推荐
- [ ] 点击"使用这个方案"，立即跳转
- [ ] 不同需求，不显示推荐
- [ ] 查看所有方案页面，显示正确
- [ ] 删除方案功能正常
- [ ] 首页"查看所有方案"按钮显示数量正确
- [ ] 切换方案后，学习路径页显示正确方案
- [ ] 进度数据保存正确

---

**服务器地址**：http://localhost:3000

**测试API Key**：sk-ba931fec9ce040b4b0bcb7dfe2fa6dde
