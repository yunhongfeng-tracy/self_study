<!DOCTYPE html>
<html>
<head>
    <title>Test Stream API</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        #result { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
        button { padding: 10px 20px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>Test AI Stream API</h1>
    <button onclick="testStream()">Test with Real API Key</button>
    <div id="result"></div>

    <script>
        async function testStream() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Testing...\n';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: [{
                            role: 'user',
                            content: '请为以下用户生成物理学习路径：学习目标：掌握经典力学基础，当前水平：高中物理基础，每天可学习时间：1-2小时，学习方式偏好：视频、互动工具'
                        }],
                        apiKey: 'sk-ba931fec9ce040b4b0bcb7dfe2fa6dde'
                    })
                });

                resultDiv.innerHTML += `Status: ${response.status}\n`;
                resultDiv.innerHTML += `Headers: ${JSON.stringify([...response.headers.entries()])}\n\n`;

                if (!response.ok) {
                    const error = await response.text();
                    resultDiv.innerHTML += `Error: ${error}\n`;
                    return;
                }

                // Read stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    fullText += chunk;
                    resultDiv.innerHTML += chunk;
                }

                resultDiv.innerHTML += '\n\n=== Full Response ===\n';
                resultDiv.innerHTML += fullText;
                resultDiv.innerHTML += '\n\n=== Length: ' + fullText.length + ' ===';
            } catch (error) {
                resultDiv.innerHTML += 'Error: ' + error.message;
            }
        }
    </script>
</body>
</html>
